<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent API Query Builder</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // API Base URL
        const API_BASE_URL = 'http://localhost:8000';

        // Main App Component
        function App() {
            const [query, setQuery] = useState('');
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [documents, setDocuments] = useState([]);
            const [uploadedFile, setUploadedFile] = useState(null);
            const [activeTab, setActiveTab] = useState('query');
            const [stats, setStats] = useState(null);

            // Load documents and stats on component mount
            useEffect(() => {
                loadDocuments();
                loadStats();
            }, []);

            const loadDocuments = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/documentation/list`);
                    const data = await response.json();
                    setDocuments(data.documents || []);
                } catch (error) {
                    console.error('Failed to load documents:', error);
                }
            };

            const loadStats = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/documentation/stats`);
                    const data = await response.json();
                    setStats(data);
                } catch (error) {
                    console.error('Failed to load stats:', error);
                }
            };

            const handleQuerySubmit = async (e) => {
                e.preventDefault();
                if (!query.trim()) return;

                setLoading(true);
                try {
                    const response = await fetch(`${API_BASE_URL}/api/query/generate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: query,
                            include_explanation: true
                        })
                    });
                    
                    const data = await response.json();
                    setResult(data);
                } catch (error) {
                    setResult({
                        success: false,
                        error: 'Failed to generate query: ' + error.message
                    });
                } finally {
                    setLoading(false);
                }
            };

            const handleFileUpload = async (e) => {
                e.preventDefault();
                const fileInput = e.target.querySelector('input[type="file"]');
                const file = fileInput.files[0];
                
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                setLoading(true);
                try {
                    const response = await fetch(`${API_BASE_URL}/api/documentation/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    setUploadedFile(data);
                    
                    // Reload documents and stats
                    await loadDocuments();
                    await loadStats();
                    
                    // Reset file input
                    fileInput.value = '';
                } catch (error) {
                    setUploadedFile({
                        success: false,
                        error: 'Failed to upload file: ' + error.message
                    });
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-blue-600 text-white shadow-lg">
                        <div className="container mx-auto px-4 py-6">
                            <h1 className="text-3xl font-bold flex items-center">
                                <i className="fas fa-code mr-3"></i>
                                Intelligent API Query Builder
                            </h1>
                            <p className="text-blue-100 mt-2">
                                Convert natural language to API queries using RAG
                            </p>
                        </div>
                    </header>

                    {/* Stats Bar */}
                    {stats && (
                        <div className="bg-white border-b shadow-sm">
                            <div className="container mx-auto px-4 py-3">
                                <div className="flex items-center space-x-6 text-sm text-gray-600">
                                    <span>
                                        <i className="fas fa-database mr-1"></i>
                                        {stats.total_chunks} chunks
                                    </span>
                                    <span>
                                        <i className="fas fa-file-alt mr-1"></i>
                                        {stats.unique_documents} documents
                                    </span>
                                    <span>
                                        <i className="fas fa-cog mr-1"></i>
                                        Collection: {stats.collection_name}
                                    </span>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <main className="container mx-auto px-4 py-8">
                        {/* Tabs */}
                        <div className="flex mb-6 bg-white rounded-lg shadow-sm">
                            <button
                                onClick={() => setActiveTab('query')}
                                className={`px-6 py-3 font-medium rounded-l-lg transition-colors ${
                                    activeTab === 'query'
                                        ? 'bg-blue-600 text-white'
                                        : 'text-gray-600 hover:text-blue-600'
                                }`}
                            >
                                <i className="fas fa-search mr-2"></i>
                                Generate Query
                            </button>
                            <button
                                onClick={() => setActiveTab('upload')}
                                className={`px-6 py-3 font-medium transition-colors ${
                                    activeTab === 'upload'
                                        ? 'bg-blue-600 text-white'
                                        : 'text-gray-600 hover:text-blue-600'
                                }`}
                            >
                                <i className="fas fa-upload mr-2"></i>
                                Upload Documentation
                            </button>
                            <button
                                onClick={() => setActiveTab('documents')}
                                className={`px-6 py-3 font-medium rounded-r-lg transition-colors ${
                                    activeTab === 'documents'
                                        ? 'bg-blue-600 text-white'
                                        : 'text-gray-600 hover:text-blue-600'
                                }`}
                            >
                                <i className="fas fa-list mr-2"></i>
                                Documents ({documents.length})
                            </button>
                        </div>

                        {/* Query Tab */}
                        {activeTab === 'query' && (
                            <div className="space-y-6">
                                {/* Query Input */}
                                <div className="bg-white rounded-lg shadow-sm p-6">
                                    <h2 className="text-xl font-semibold mb-4">Natural Language Query</h2>
                                    <form onSubmit={handleQuerySubmit}>
                                        <div className="flex space-x-4">
                                            <input
                                                type="text"
                                                value={query}
                                                onChange={(e) => setQuery(e.target.value)}
                                                placeholder="e.g., Get current weather for Tokyo"
                                                className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                disabled={loading}
                                            />
                                            <button
                                                type="submit"
                                                disabled={loading || !query.trim()}
                                                className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                            >
                                                {loading ? (
                                                    <><i className="fas fa-spinner fa-spin mr-2"></i>Generating...</>
                                                ) : (
                                                    <><i className="fas fa-magic mr-2"></i>Generate</>
                                                )}
                                            </button>
                                        </div>
                                    </form>
                                    
                                    {/* Example Queries */}
                                    <div className="mt-4">
                                        <p className="text-sm text-gray-600 mb-2">Try these examples:</p>
                                        <div className="flex flex-wrap gap-2">
                                            {[
                                                "Get current weather for Tokyo",
                                                "Show weather forecast for 7 days",
                                                "Create a new user with email",
                                                "List all available endpoints"
                                            ].map((example, index) => (
                                                <button
                                                    key={index}
                                                    onClick={() => setQuery(example)}
                                                    className="text-xs px-3 py-1 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors"
                                                >
                                                    {example}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {/* Query Result */}
                                {result && (
                                    <div className="bg-white rounded-lg shadow-sm p-6">
                                        <h2 className="text-xl font-semibold mb-4">Generated API Query</h2>
                                        
                                        {result.success ? (
                                            <div className="space-y-4">
                                                {/* Generated Query */}
                                                <div className="bg-gray-50 p-4 rounded-lg">
                                                    <h3 className="font-medium mb-2">API Call</h3>
                                                    <div className="font-mono text-sm">
                                                        <div className="text-green-600 font-bold">
                                                            {result.generated_query?.method} {result.generated_query?.url}
                                                        </div>
                                                        {result.generated_query?.headers && (
                                                            <div className="mt-2 text-blue-600">
                                                                Headers: {JSON.stringify(result.generated_query.headers, null, 2)}
                                                            </div>
                                                        )}
                                                        {result.generated_query?.body && (
                                                            <div className="mt-2 text-purple-600">
                                                                Body: {JSON.stringify(result.generated_query.body, null, 2)}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* Confidence and Context */}
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div className="bg-blue-50 p-3 rounded-lg">
                                                        <h4 className="font-medium text-blue-800">Confidence</h4>
                                                        <p className="text-2xl font-bold text-blue-600">
                                                            {Math.round((result.generated_query?.confidence || 0) * 100)}%
                                                        </p>
                                                    </div>
                                                    <div className="bg-green-50 p-3 rounded-lg">
                                                        <h4 className="font-medium text-green-800">Context Used</h4>
                                                        <p className="text-2xl font-bold text-green-600">
                                                            {result.context_used || 0} chunks
                                                        </p>
                                                    </div>
                                                </div>

                                                {/* Explanation */}
                                                {result.explanation && (
                                                    <div className="bg-yellow-50 p-4 rounded-lg">
                                                        <h4 className="font-medium text-yellow-800 mb-2">Explanation</h4>
                                                        <pre className="text-sm text-yellow-700 whitespace-pre-wrap">
                                                            {result.explanation}
                                                        </pre>
                                                    </div>
                                                )}

                                                {/* Relevant Documents */}
                                                {result.relevant_documents && result.relevant_documents.length > 0 && (
                                                    <div className="bg-gray-50 p-4 rounded-lg">
                                                        <h4 className="font-medium mb-2">Relevant Documents</h4>
                                                        <div className="space-y-2">
                                                            {result.relevant_documents.map((doc, index) => (
                                                                <div key={index} className="flex justify-between items-center text-sm">
                                                                    <span className="font-medium">{doc.document}</span>
                                                                    <span className="text-gray-500">
                                                                        {doc.doc_type} (score: {doc.relevance_score?.toFixed(3)})
                                                                    </span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ) : (
                                            <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                                                <div className="flex items-center">
                                                    <i className="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                                                    <div>
                                                        <h3 className="font-medium text-red-800">Error</h3>
                                                        <p className="text-red-600">{result.error}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Upload Tab */}
                        {activeTab === 'upload' && (
                            <div className="bg-white rounded-lg shadow-sm p-6">
                                <h2 className="text-xl font-semibold mb-4">Upload API Documentation</h2>
                                <form onSubmit={handleFileUpload}>
                                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                                        <i className="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                        <input
                                            type="file"
                                            accept=".json,.yaml,.yml"
                                            className="mb-4"
                                            disabled={loading}
                                        />
                                        <p className="text-gray-600 mb-4">
                                            Upload OpenAPI/Swagger JSON or YAML files, or Postman collections
                                        </p>
                                        <button
                                            type="submit"
                                            disabled={loading}
                                            className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors"
                                        >
                                            {loading ? (
                                                <><i className="fas fa-spinner fa-spin mr-2"></i>Uploading...</>
                                            ) : (
                                                <><i className="fas fa-upload mr-2"></i>Upload</>
                                            )}
                                        </button>
                                    </div>
                                </form>

                                {uploadedFile && (
                                    <div className={`mt-4 p-4 rounded-lg ${uploadedFile.success ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`}>
                                        <div className="flex items-center">
                                            <i className={`fas ${uploadedFile.success ? 'fa-check-circle text-green-500' : 'fa-exclamation-triangle text-red-500'} mr-3`}></i>
                                            <div>
                                                <h3 className={`font-medium ${uploadedFile.success ? 'text-green-800' : 'text-red-800'}`}>
                                                    {uploadedFile.success ? 'Upload Successful' : 'Upload Failed'}
                                                </h3>
                                                <p className={uploadedFile.success ? 'text-green-600' : 'text-red-600'}>
                                                    {uploadedFile.message || uploadedFile.error}
                                                </p>
                                                {uploadedFile.success && (
                                                    <p className="text-sm text-green-600 mt-1">
                                                        Type: {uploadedFile.type} | Endpoints: {uploadedFile.endpoints_parsed} | Size: {Math.round(uploadedFile.file_size / 1024)}KB
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Documents Tab */}
                        {activeTab === 'documents' && (
                            <div className="bg-white rounded-lg shadow-sm p-6">
                                <h2 className="text-xl font-semibold mb-4">Uploaded Documents</h2>
                                
                                {documents.length === 0 ? (
                                    <div className="text-center py-8 text-gray-500">
                                        <i className="fas fa-inbox text-4xl mb-4"></i>
                                        <p>No documents uploaded yet</p>
                                        <p className="text-sm">Upload some API documentation to get started</p>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {documents.map((doc) => (
                                            <div key={doc.id} className="border border-gray-200 rounded-lg p-4">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <h3 className="font-medium text-lg">{doc.name}</h3>
                                                        <div className="flex items-center space-x-4 text-sm text-gray-600 mt-1">
                                                            <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                                                                {doc.type}
                                                            </span>
                                                            <span>
                                                                <i className="fas fa-code mr-1"></i>
                                                                {doc.endpoints_count} endpoints
                                                            </span>
                                                            <span>
                                                                <i className="fas fa-file mr-1"></i>
                                                                {Math.round(doc.file_size / 1024)}KB
                                                            </span>
                                                            <span>
                                                                <i className="fas fa-calendar mr-1"></i>
                                                                {new Date(doc.uploaded_at).toLocaleDateString()}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <button className="text-red-600 hover:text-red-800 transition-colors">
                                                        <i className="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>